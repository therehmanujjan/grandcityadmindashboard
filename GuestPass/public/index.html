<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; img-src 'self' data: blob:; connect-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;">
    <title>Grand City HQ - Guest Pass Management System</title>
    
    <!-- React and Babel from local files -->
    <script src="./react.production.min.js"></script>
    <script src="./react-dom.production.min.js"></script>
    <script src="./babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR Code and utilities from local files -->
    <script src="./qrcode.min.js"></script>
    <script src="./html2canvas.min.js"></script>
    <script src="./jsQR.js"></script>
    
    <!-- Library loading verification and fallback system -->
    <script>
        // Enhanced library loading with fallbacks
        window.libraryLoadStatus = {
            react: false,
            reactDOM: false,
            qrcode: false,
            html2canvas: false,
            jsQR: false,
            tailwind: false
        };

        // Function to check library loading status
        function checkLibraryStatus() {
            window.libraryLoadStatus.react = typeof React !== 'undefined';
            window.libraryLoadStatus.reactDOM = typeof ReactDOM !== 'undefined';
            window.libraryLoadStatus.qrcode = typeof QRCode !== 'undefined';
            window.libraryLoadStatus.html2canvas = typeof html2canvas !== 'undefined';
            window.libraryLoadStatus.jsQR = typeof jsQR !== 'undefined';
            window.libraryLoadStatus.tailwind = typeof tailwind !== 'undefined';
            
            const missingLibraries = Object.keys(window.libraryLoadStatus).filter(key => !window.libraryLoadStatus[key]);
            
            if (missingLibraries.length > 0) {
                console.warn('Missing libraries:', missingLibraries.join(', '));
                return false;
            } else {
                console.log('✅ All required libraries loaded successfully');
                return true;
            }
        }

        // Wait for libraries to load with timeout
        function waitForLibraries(callback, timeout = 10000) {
            const startTime = Date.now();
            const checkInterval = 100; // Check every 100ms
            
            const interval = setInterval(() => {
                if (checkLibraryStatus()) {
                    clearInterval(interval);
                    callback(true);
                } else if (Date.now() - startTime > timeout) {
                    clearInterval(interval);
                    console.error('❌ Library loading timeout after', timeout, 'ms');
                    callback(false);
                }
            }, checkInterval);
        }

        // Global error handler for library loading
        window.addEventListener('error', function(e) {
            console.error('Script loading error:', e.filename, e.message);
        });

        // Initialize library checking when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded, checking libraries...');
            });
        } else {
            console.log('DOM already loaded, checking libraries...');
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // QR Code Generation Utility with enhanced loading
        const generateQRCode = async (text) => {
            try {
                // Wait for QRCode library to be available
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds timeout
                
                while (typeof QRCode === 'undefined' && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof QRCode === 'undefined') {
                    console.error('QR code library failed to load after 5 seconds');
                    return null;
                }
                
                // Create a temporary container div for QR code generation
                const tempDiv = document.createElement('div');
                tempDiv.style.display = 'none';
                document.body.appendChild(tempDiv);
                
                // Generate QR code in the temporary div
                const qrCode = new QRCode(tempDiv, {
                    text: text,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#FFFFFF',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                // Wait for QR code to be generated
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Find the canvas element created by QRCode library
                const canvas = tempDiv.querySelector('canvas');
                if (!canvas) {
                    console.error('QR code canvas not found');
                    document.body.removeChild(tempDiv);
                    return null;
                }
                
                // Get data URL from canvas
                const dataUrl = canvas.toDataURL('image/png');
                
                // Clean up temporary div
                document.body.removeChild(tempDiv);
                
                return dataUrl;
            } catch (e) {
                console.error('QR generation error:', e);
                return null;
            }
        };

        // Executives will be loaded from API
        let EXECUTIVES = [];

        // No hardcoded data - everything from database

        // Authentication helper - get token from session storage
        const getAuthToken = () => {
            return sessionStorage.getItem('authToken');
        };

        // Helper to add auth header to fetch requests
        const authFetch = async (url, options = {}) => {
            const token = getAuthToken();
            const headers = {
                ...options.headers,
                'Authorization': token ? `Bearer ${token}` : ''
            };
            
            const response = await fetch(url, { ...options, headers });
            
            // If unauthorized, redirect to login
            if (response.status === 401 || response.status === 403) {
                sessionStorage.removeItem('authToken');
                sessionStorage.removeItem('user');
                window.location.reload();
            }
            
            return response;
        };

        // Utility Functions
        // Note: generateVisitCode is now an API endpoint utility
        // Visit codes are generated by the database trigger when visits are created
        const generateVisitCode = async () => {
            try {
                const response = await authFetch('/api/visits/generate-code');
                if (!response.ok) {
                    throw new Error('Failed to generate visit code');
                }
                const data = await response.json();
                console.log('Generated visit code from database:', data.code);
                return data.code;
            } catch (e) {
                console.error('Error generating visit code:', e);
                // Fallback: Use timestamp-based code
                const year = new Date().getFullYear();
                return `GC-${year}-${Date.now().toString().slice(-6)}`;
            }
        };

        const getVisits = async () => {
            try {
                const response = await authFetch('/api/visits');
                if (!response.ok) throw new Error('Failed to fetch visits');
                const visits = await response.json();
                // Transform to match frontend format
                return visits.map(v => ({
                    id: v.id,
                    code: v.code,
                    visitor: {
                        name: v.visitor_name,
                        email: v.visitor_email,
                        phone: v.visitor_phone,
                        company: v.visitor_company
                    },
                    executiveId: v.executive_id,
                    executiveName: v.executive_name,
                    purpose: v.purpose,
                    date: v.date,
                    timeFrom: v.time_from,
                    timeTo: v.time_to,
                    status: v.status,
                    approval: v.approval,
                    type: v.type,
                    checkinTime: v.actual_checkin,
                    checkoutTime: v.actual_checkout,
                    createdAt: v.created_at
                }));
            } catch (e) {
                console.error('Error getting visits:', e);
                return [];
            }
        };

        const saveVisit = async (visit) => {
            try {
                // Save to backend database
                const response = await authFetch('/api/visits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        visitor: {
                            name: visit.visitor.name,
                            email: visit.visitor.email,
                            phone: visit.visitor.phone,
                            company: visit.visitor.company
                        },
                        executive_id: visit.executiveId,
                        date: visit.date,
                        time_from: visit.timeFrom,
                        time_to: visit.timeTo,
                        purpose: visit.purpose,
                        visit_type: visit.type || 'scheduled'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save visit to database');
                }

                const result = await response.json();
                console.log('=== Visit Save Response ===');
                console.log('Full result:', result);
                console.log('Visit code from API:', result.visit_code);
                console.log('Visit ID from API:', result.id);
                
                return result;
            } catch (e) {
                console.error('Error saving visit:', e);
                alert('Unable to save visit to database. Please check your connection.');
                throw e;
            }
        };

        const updateVisit = async (id, updates) => {
            try {
                const response = await fetch(`/api/visits/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });

                if (!response.ok) {
                    throw new Error('Failed to update visit');
                }

                const result = await response.json();
                console.log('Visit updated successfully:', result);
                return result;
            } catch (e) {
                console.error('Error updating visit:', e);
                alert('Unable to update visit. Please try again.');
                throw e;
            }
        };

        // Components
        const DigitalPass = ({ visit, executive, onClose, onShare }) => {
            const passRef = useRef(null);
            const [qrCodeUrl, setQrCodeUrl] = useState('');
            const [isGeneratingQR, setIsGeneratingQR] = useState(true);
            
            // Fallback for executive if not found
            const executiveData = executive || { name: 'Executive', position: 'Staff' };

            // Log the visit code received as prop
            useEffect(() => {
                console.log('=== DigitalPass Component Rendered ===');
                console.log('Received visit object:', visit);
                console.log('Received visit.code:', visit?.code);
            }, [visit]);

            useEffect(() => {
                // Generate QR code
                const generateQR = async () => {
                    setIsGeneratingQR(true);
                    console.log('=== Generating QR Code for:', visit.code, '===');
                    try {
                        const qrUrl = await generateQRCode(visit.code);
                        setQrCodeUrl(qrUrl);
                        console.log('QR Code generated successfully');
                    } catch (e) {
                        console.error('Failed to generate QR code:', e);
                    } finally {
                        setIsGeneratingQR(false);
                    }
                };
                generateQR();
            }, [visit.code]);

            const handleDownload = async () => {
                if (passRef.current) {
                    try {
                        // Check if html2canvas is available
                        if (typeof html2canvas === 'undefined') {
                            alert('Download feature is not available. Please try again later.');
                            return;
                        }
                        
                        // Wait a bit for any async operations to complete
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Clone the pass element to render it without parent constraints
                        const passElement = passRef.current;
                        const clone = passElement.cloneNode(true);
                        
                        // Create temporary container
                        const tempContainer = document.createElement('div');
                        tempContainer.style.position = 'absolute';
                        tempContainer.style.left = '-9999px';
                        tempContainer.style.top = '0';
                        tempContainer.style.width = 'auto';
                        tempContainer.style.height = 'auto';
                        tempContainer.style.overflow = 'visible';
                        tempContainer.appendChild(clone);
                        document.body.appendChild(tempContainer);
                        
                        const canvas = await html2canvas(clone, {
                            backgroundColor: '#ffffff',
                            scale: 2,
                            useCORS: true,
                            allowTaint: true,
                            logging: false
                        });
                        
                        // Remove temporary container
                        document.body.removeChild(tempContainer);
                        
                        // Convert canvas to data URL
                        const dataURL = canvas.toDataURL('image/png');
                        
                        // Create download link
                        const link = document.createElement('a');
                        link.download = `GrandCity-Pass-${visit.code}.png`;
                        link.href = dataURL;
                        link.style.display = 'none';
                        
                        // Add to document, click, and remove
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                    } catch (e) {
                        console.error('Download error:', e);
                        alert('Download feature requires a modern browser. Error: ' + e.message);
                    }
                } else {
                    alert('Unable to generate pass image');
                }
            };

            const handleWhatsAppShare = () => {
                const message = `*Grand City HQ - Visitor Pass*

*Visitor:* ${visit.visitor.name}
*Company:* ${visit.visitor.company || 'N/A'}
*Meeting With:* ${executiveData.name}
*Date:* ${new Date(visit.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
*Time:* ${visit.timeFrom} - ${visit.timeTo}
*Visit Code:* ${visit.code}

Please show this pass at the gate for verification.

Grand City HQ
Visit Management System`;

                // Clean phone number for WhatsApp (remove non-digits and ensure it starts with country code)
                let cleanPhone = visit.visitor.phone.replace(/[^0-9]/g, '');
                if (cleanPhone.startsWith('92') && cleanPhone.length === 12) {
                    // Already has country code
                } else if (cleanPhone.startsWith('0')) {
                    // Remove leading 0 and add country code
                    cleanPhone = '92' + cleanPhone.substring(1);
                } else if (cleanPhone.length === 10) {
                    // Assume it's a local number, add country code
                    cleanPhone = '92' + cleanPhone;
                }
                
                // Use WhatsApp web link as fallback
                const whatsappUrl = `https://web.whatsapp.com/send?phone=${cleanPhone}&text=${encodeURIComponent(message)}`;
                
                try {
                    // Try to open in a new tab
                    const newWindow = window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    if (!newWindow) {
                        // If popup blocked, copy to clipboard
                        throw new Error('Popup blocked');
                    }
                } catch (e) {
                    // Fallback to copying message to clipboard
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(message).then(() => {
                            alert('WhatsApp message copied to clipboard. You can paste it manually.');
                        }).catch(() => {
                            alert('Unable to open WhatsApp or copy message. Please copy manually:\n\n' + message);
                        });
                    } else {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = message;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('WhatsApp message copied to clipboard. You can paste it manually.');
                    }
                }
            };

            const handleSMSShare = () => {
                const message = `Grand City HQ - Your visitor pass:\nCode: ${visit.code}\nDate: ${visit.date}\nTime: ${visit.timeFrom}\nMeeting: ${executiveData.name}\nShow this at gate.`;
                const smsUrl = `sms:${visit.visitor.phone}?body=${encodeURIComponent(message)}`;
                window.open(smsUrl, '_blank');
            };

            const statusColor = visit.approval === 'approved' ? 'bg-green-500' : 'bg-orange-500';
            const statusText = visit.approval === 'approved' ? 'APPROVED' : 'PENDING APPROVAL';

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold text-gray-900">Digital Visitor Pass</h2>
                                <button 
                                    onClick={onClose}
                                    className="text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            {/* Digital Pass Card */}
                            <div ref={passRef} className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl p-6 text-white mb-6 shadow-2xl">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h3 className="text-sm font-semibold opacity-90">GRAND CITY HQ</h3>
                                        <p className="text-xs opacity-75">Visitor Pass</p>
                                    </div>
                                    <div className={`${statusColor} px-3 py-1 rounded-full text-xs font-bold`}>
                                        {statusText}
                                    </div>
                                </div>

                                {/* QR Code */}
                                {isGeneratingQR && (
                                    <div className="bg-white rounded-lg p-4 mb-6 flex justify-center items-center h-48">
                                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                                    </div>
                                )}
                                {!isGeneratingQR && qrCodeUrl && (
                                    <div className="bg-white rounded-lg p-4 mb-6 flex justify-center">
                                        <img src={qrCodeUrl} alt="QR Code" className="w-48 h-48" />
                                    </div>
                                )}
                                {!isGeneratingQR && !qrCodeUrl && (
                                    <div className="bg-gray-100 rounded-lg p-4 mb-6 text-center">
                                        <div className="text-gray-500 text-sm mb-2">QR Code not available</div>
                                        <div className="bg-white border-2 border-dashed border-gray-300 rounded-lg p-8">
                                            <div className="text-2xl font-mono text-gray-700">{visit.code}</div>
                                            <div className="text-xs text-gray-500 mt-2">Show this code at the gate</div>
                                        </div>
                                    </div>
                                )}

                                {/* Visit Code */}
                                <div className="bg-white bg-opacity-20 rounded-lg p-4 mb-6 backdrop-blur-sm">
                                    <p className="text-xs opacity-75 mb-1">VISIT CODE</p>
                                    <p className="text-2xl font-bold tracking-wider">{visit.code}</p>
                                </div>

                                {/* Visitor Details */}
                                <div className="space-y-3">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="text-xs opacity-75">VISITOR</p>
                                            <p className="font-semibold">{visit.visitor.name}</p>
                                            {visit.visitor.company && (
                                                <p className="text-sm opacity-90">{visit.visitor.company}</p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p className="text-xs opacity-75">MEETING WITH</p>
                                            <p className="text-sm font-semibold">{executiveData.name}</p>
                                            <p className="text-xs opacity-90">{executiveData.position}</p>
                                        </div>
                                        <div>
                                            <p className="text-xs opacity-75">VISIT TYPE</p>
                                            <p className="text-sm font-semibold capitalize">{visit.type.replace('_', ' ')}</p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <p className="text-xs opacity-75">DATE</p>
                                            <p className="text-sm font-semibold">
                                                {new Date(visit.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                            </p>
                                        </div>
                                        <div>
                                            <p className="text-xs opacity-75">TIME</p>
                                            <p className="text-sm font-semibold">{visit.timeFrom} - {visit.timeTo}</p>
                                        </div>
                                    </div>

                                    <div className="border-t border-white border-opacity-30 pt-3 mt-3">
                                        <p className="text-xs opacity-75">PURPOSE</p>
                                        <p className="text-sm">{visit.purpose}</p>
                                    </div>
                                </div>

                                {/* Footer */}
                                <div className="mt-6 pt-4 border-t border-white border-opacity-30 text-center">
                                    <p className="text-xs opacity-75">Please present this pass at the security gate</p>
                                    <p className="text-xs opacity-60 mt-1">Generated: {new Date(visit.createdAt).toLocaleString()}</p>
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div className="space-y-3">
                                <button
                                    onClick={handleWhatsAppShare}
                                    className="w-full px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-semibold flex items-center justify-center space-x-2"
                                >
                                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                    </svg>
                                    <span>Share via WhatsApp</span>
                                </button>

                                <div className="grid grid-cols-2 gap-3">
                                    <button
                                        onClick={handleSMSShare}
                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center space-x-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                        </svg>
                                        <span>SMS</span>
                                    </button>
                                    <button
                                        onClick={handleDownload}
                                        className="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors font-medium flex items-center justify-center space-x-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        <span>Download</span>
                                    </button>
                                </div>

                                <button
                                    onClick={onClose}
                                    className="w-full px-6 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
                                >
                                    Close
                                </button>
                            </div>

                            {visit.approval === 'pending' && (
                                <div className="mt-4 bg-orange-50 border border-orange-200 rounded-lg p-4">
                                    <div className="flex items-start">
                                        <svg className="w-5 h-5 text-orange-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                        <div>
                                            <p className="text-sm font-medium text-orange-900">Awaiting Approval</p>
                                            <p className="text-sm text-orange-700 mt-1">
                                                The executive has been notified. You'll receive confirmation once approved. 
                                                You can share this pass now - it will be valid once approved.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, executives = [] }) => {
            const [role, setRole] = useState('executive');
            const [selectedExec, setSelectedExec] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            // Set first executive as default when executives list is loaded
            useEffect(() => {
                if (executives.length > 0 && !selectedExec) {
                    setSelectedExec(executives[0].id);
                }
            }, [executives.length]);

            // Map role/executive selection to email for authentication
            const getEmailFromSelection = () => {
                if (role === 'executive' && selectedExec) {
                    const exec = executives.find(e => e.id === selectedExec);
                    return exec?.email;
                }
                // For non-executive roles, use a default pattern
                if (role === 'admin') return 'admin@grandcity.pk';
                if (role === 'staff') return 'staff@grandcity.pk';
                if (role === 'guard') return 'guard@grandcity.pk';
                if (role === 'receptionist') return 'receptionist@grandcity.pk';
                return null;
            };

            const handleLogin = async () => {
                if (!password) {
                    setError('Please enter password');
                    return;
                }

                const email = getEmailFromSelection();
                if (!email) {
                    setError('Please select a valid role/executive');
                    return;
                }

                setLoading(true);
                setError('');

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password }),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        setError(data.error || 'Incorrect password. Please try again.');
                        setLoading(false);
                        return;
                    }

                    // Store token in sessionStorage
                    sessionStorage.setItem('authToken', data.token);
                    sessionStorage.setItem('user', JSON.stringify(data.user));

                    // Call onLogin with user data
                    onLogin({
                        role: data.user.role,
                        executiveId: data.user.executiveId,
                        user: data.user
                    });

                } catch (err) {
                    console.error('Login error:', err);
                    setError('Network error. Please check your connection.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-600 text-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg className="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800">Grand City HQ</h1>
                            <p className="text-gray-600 mt-2">Guest Pass Management System</p>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Select Role</label>
                                <select 
                                    value={role} 
                                    onChange={(e) => setRole(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                >
                                    <option value="executive">Executive</option>
                                    <option value="staff">Staff Member</option>
                                    <option value="guard">Security Guard</option>
                                    <option value="receptionist">Receptionist</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>

                            {role === 'executive' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Select Executive</label>
                                    <select 
                                        value={selectedExec} 
                                        onChange={(e) => setSelectedExec(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    >
                                        {executives.map(exec => (
                                            <option key={exec.id} value={exec.id}>
                                                {exec.name} - {exec.position}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        setError('');
                                    }}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && password) {
                                            handleLogin();
                                        }
                                    }}
                                    placeholder="Enter your password"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                                {error && (
                                    <p className="mt-2 text-sm text-red-600">{error}</p>
                                )}
                            </div>

                            <button
                                onClick={handleLogin}
                                disabled={!password || loading}
                                className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-200 shadow-lg hover:shadow-xl disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Logging in...' : 'Login to Dashboard'}
                            </button>
                        </div>
                                    </select>
                                </div>
                            )}

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Site Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => {
                                        setPassword(e.target.value);
                                        setError('');
                                    }}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && password) {
                                            handleLogin();
                                        }
                                    }}
                                    placeholder="Enter site password"
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                                {error && (
                                    <p className="mt-2 text-sm text-red-600">{error}</p>
                                )}
                            </div>

                            <button
                                onClick={handleLogin}
                                disabled={!password}
                                className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-200 shadow-lg hover:shadow-xl disabled:bg-gray-400 disabled:cursor-not-allowed"
                            >
                                Login to Dashboard
                            </button>
                        </div>


                    </div>
                </div>
            );
        };

        const ExecutiveDashboard = ({ user }) => {
            const [visits, setVisits] = useState([]);
            const executive = EXECUTIVES.find(e => e.id === user.executiveId) || { 
                name: user.name || 'Executive', 
                position: user.role || 'Executive',
                id: user.executiveId 
            };

            useEffect(() => {
                const loadVisits = async () => {
                    const allVisits = await getVisits();
                    const myVisits = allVisits.filter(v => v.executiveId === user.executiveId);
                    setVisits(myVisits);
                };
                loadVisits();
            }, [user.executiveId]);

            const todayVisits = visits.filter(v => v.date === new Date().toISOString().split('T')[0]);
            const pendingApprovals = visits.filter(v => v.approval === 'pending');
            const thisWeekVisits = visits.filter(v => {
                const visitDate = new Date(v.date);
                const today = new Date();
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                return visitDate >= weekAgo && visitDate <= today;
            });

            const handleApproval = async (visitId, status) => {
                await updateVisit(visitId, { approval: status, approvedAt: new Date().toISOString() });
                const allVisits = await getVisits();
                const myVisits = allVisits.filter(v => v.executiveId === user.executiveId);
                setVisits(myVisits);
            };

            const getStatusBadge = (status) => {
                const styles = {
                    scheduled: 'bg-blue-100 text-blue-800',
                    checked_in: 'bg-green-100 text-green-800',
                    checked_out: 'bg-gray-100 text-gray-800',
                    cancelled: 'bg-red-100 text-red-800'
                };
                return styles[status] || 'bg-gray-100 text-gray-800';
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Welcome, {executive.name}</h1>
                                    <p className="text-sm text-gray-600">{executive.position}</p>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className="text-right">
                                        <p className="text-sm text-gray-600">Today's Date</p>
                                        <p className="text-sm font-semibold">{new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    </div>
                                    <div className="bg-indigo-600 text-white w-12 h-12 rounded-full flex items-center justify-center">
                                        {executive.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                        {/* Quick Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="text-sm text-gray-600 mb-1">Today</div>
                                <div className="text-3xl font-bold text-indigo-600">{todayVisits.length}</div>
                                <div className="text-xs text-gray-500 mt-1">Scheduled Visits</div>
                            </div>
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="text-sm text-gray-600 mb-1">This Week</div>
                                <div className="text-3xl font-bold text-blue-600">{thisWeekVisits.length}</div>
                                <div className="text-xs text-gray-500 mt-1">Total Visits</div>
                            </div>
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="text-sm text-gray-600 mb-1">Pending</div>
                                <div className="text-3xl font-bold text-orange-600">{pendingApprovals.length}</div>
                                <div className="text-xs text-gray-500 mt-1">Awaiting Approval</div>
                            </div>
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="text-sm text-gray-600 mb-1">Checked In</div>
                                <div className="text-3xl font-bold text-green-600">{todayVisits.filter(v => v.status === 'checked_in').length}</div>
                                <div className="text-xs text-gray-500 mt-1">Currently Here</div>
                            </div>
                        </div>

                        {/* Pending Approvals */}
                        {pendingApprovals.length > 0 && (
                            <div className="bg-white rounded-lg shadow mb-8">
                                <div className="px-6 py-4 border-b border-gray-200">
                                    <h2 className="text-lg font-semibold text-gray-900 flex items-center">
                                        <span className="bg-orange-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm mr-2">
                                            {pendingApprovals.length}
                                        </span>
                                        Pending Approvals
                                    </h2>
                                </div>
                                <div className="divide-y divide-gray-200">
                                    {pendingApprovals.map(visit => (
                                        <div key={visit.id} className="p-6 hover:bg-gray-50 transition-colors">
                                            <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                    <div className="flex items-center mb-2">
                                                        <div className="bg-gray-200 rounded-full w-12 h-12 flex items-center justify-center mr-4">
                                                            <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                            </svg>
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-semibold text-gray-900">{visit.visitor.name}</h3>
                                                            <p className="text-sm text-gray-600">{visit.visitor.company}</p>
                                                        </div>
                                                    </div>
                                                    <div className="ml-16 space-y-1">
                                                        <p className="text-sm text-gray-700"><span className="font-medium">Purpose:</span> {visit.purpose}</p>
                                                        <p className="text-sm text-gray-700">
                                                            <span className="font-medium">Type:</span> 
                                                            <span className="ml-2 px-2 py-0.5 text-xs rounded-full bg-purple-100 text-purple-800">
                                                                {visit.type === 'walk_in' ? 'Walk-in' : 'Scheduled'}
                                                            </span>
                                                        </p>
                                                        {visit.type === 'walk_in' && (
                                                            <p className="text-sm text-orange-600">
                                                                <span className="font-medium">⏰ Arrived:</span> {new Date(visit.createdAt).toLocaleTimeString()}
                                                            </p>
                                                        )}
                                                        <p className="text-sm text-gray-700"><span className="font-medium">Phone:</span> {visit.visitor.phone}</p>
                                                    </div>
                                                </div>
                                                <div className="flex space-x-2 ml-4">
                                                    <button
                                                        onClick={() => handleApproval(visit.id, 'approved')}
                                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                                                    >
                                                        ✓ Approve
                                                    </button>
                                                    <button
                                                        onClick={() => handleApproval(visit.id, 'rejected')}
                                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                                                    >
                                                        ✗ Reject
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Today's Schedule */}
                        <div className="bg-white rounded-lg shadow">
                            <div className="px-6 py-4 border-b border-gray-200">
                                <h2 className="text-lg font-semibold text-gray-900">Today's Schedule</h2>
                            </div>
                            <div className="divide-y divide-gray-200">
                                {todayVisits.length === 0 ? (
                                    <div className="p-6 text-center text-gray-500">
                                        <svg className="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <p>No visits scheduled for today</p>
                                    </div>
                                ) : (
                                    todayVisits.map(visit => (
                                        <div key={visit.id} className="p-6 hover:bg-gray-50 transition-colors">
                                            <div className="flex justify-between items-start">
                                                <div className="flex items-start space-x-4 flex-1">
                                                    <div className="text-center min-w-[80px]">
                                                        <div className="text-2xl font-bold text-indigo-600">{visit.timeFrom}</div>
                                                        <div className="text-xs text-gray-500">to {visit.timeTo}</div>
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center mb-2">
                                                            <h3 className="text-lg font-semibold text-gray-900">{visit.visitor.name}</h3>
                                                            <span className={`ml-3 px-3 py-1 text-xs font-medium rounded-full ${getStatusBadge(visit.status)}`}>
                                                                {visit.status.replace('_', ' ').toUpperCase()}
                                                            </span>
                                                        </div>
                                                        <p className="text-sm text-gray-600 mb-1">{visit.visitor.company}</p>
                                                        <p className="text-sm text-gray-700">{visit.purpose}</p>
                                                        <p className="text-xs text-gray-500 mt-2">Code: {visit.code}</p>
                                                    </div>
                                                </div>
                                                {visit.status === 'checked_in' && (
                                                    <div className="ml-4 text-right">
                                                        <div className="text-sm text-green-600 font-medium">● Currently Here</div>
                                                        <div className="text-xs text-gray-500 mt-1">Checked in at {new Date(visit.checkinTime).toLocaleTimeString()}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StaffDashboard = () => {
            const [showScheduleForm, setShowScheduleForm] = useState(false);
            const [showPassPreview, setShowPassPreview] = useState(false);
            const [createdVisit, setCreatedVisit] = useState(null);
            const [formData, setFormData] = useState({
                visitorName: '',
                company: '',
                phone: '',
                email: '',
                executiveId: '',
                purpose: '',
                visitType: 'scheduled',
                date: new Date().toISOString().split('T')[0],
                timeFrom: '09:00',
                timeTo: '10:00'
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // For walk-in, use current time
                const isWalkIn = formData.visitType === 'walk_in';
                const currentTime = new Date();
                const visitDate = isWalkIn ? new Date().toISOString().split('T')[0] : formData.date;
                
                // Format time properly for database (HH:MM:SS)
                const formatTime = (date) => {
                    return date.toTimeString().split(' ')[0].substring(0, 5); // Returns HH:MM
                };
                
                const timeFrom = isWalkIn ? formatTime(currentTime) : formData.timeFrom;
                const timeTo = isWalkIn ? formatTime(new Date(currentTime.getTime() + 3600000)) : formData.timeTo;
                
                const visit = {
                    id: Date.now(),
                    code: null, // Will be set from database
                    visitor: {
                        name: formData.visitorName,
                        company: formData.company,
                        phone: formData.phone,
                        email: formData.email
                    },
                    executiveId: formData.executiveId,
                    purpose: formData.purpose,
                    date: visitDate,
                    timeFrom: timeFrom,
                    timeTo: timeTo,
                    status: 'scheduled',
                    approval: 'pending', // All visits require approval
                    type: formData.visitType,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const result = await saveVisit(visit);
                    
                    console.log('=== Staff Dashboard - After Save ===');
                    console.log('Result object:', result);
                    console.log('Result.visit_code:', result?.visit_code);
                    console.log('Original visit.code before spread:', visit.code);
                    
                    // Create new visit object with database-generated code
                    // API returns visit object directly with visit_code property
                    if (result && result.visit_code) {
                        const visitWithCode = {
                            ...visit,
                            code: result.visit_code,
                            id: result.id
                        };
                        
                        // Freeze the code to catch any modifications
                        Object.defineProperty(visitWithCode, 'code', {
                            value: result.visit_code,
                            writable: false,
                            configurable: false
                        });
                        
                        console.log('Created visitWithCode object:', visitWithCode);
                        console.log('visitWithCode.code AFTER creation:', visitWithCode.code);
                        console.log('Verify: result.visit_code was:', result.visit_code);
                        console.log('=== ABOUT TO SHOW PASS WITH CODE:', visitWithCode.code, '===');
                        console.log('Type check - code is:', typeof visitWithCode.code, visitWithCode.code);
                        
                        // Show digital pass preview with database code
                        setCreatedVisit(visitWithCode);
                        
                        // Verify state update (will log on next render)
                        setTimeout(() => {
                            console.log('=== STATE CHECK: createdVisit should be set now ===');
                        }, 100);
                    } else {
                        console.warn('No visit_code in response, using visit as-is');
                        setCreatedVisit(visit);
                    }
                    
                    setShowPassPreview(true);
                    setShowScheduleForm(false);
                    
                    // Reset form
                    setFormData({
                        visitorName: '',
                        company: '',
                        phone: '',
                        email: '',
                        executiveId: '',
                        purpose: '',
                        visitType: 'scheduled',
                        date: new Date().toISOString().split('T')[0],
                        timeFrom: '09:00',
                        timeTo: '10:00'
                    });
                } catch (error) {
                    console.error('Failed to create visit:', error);
                }
            };

            // Set first executive as default when executives list is loaded
            useEffect(() => {
                if (EXECUTIVES.length > 0 && !formData.executiveId) {
                    setFormData(prev => ({...prev, executiveId: EXECUTIVES[0].id}));
                }
            }, [EXECUTIVES.length]);

            return (
                <div className="min-h-screen bg-gray-50">
                    {showPassPreview && createdVisit && (
                        <DigitalPass 
                            visit={createdVisit}
                            executive={EXECUTIVES.find(e => e.id === createdVisit.executiveId)}
                            onClose={() => setShowPassPreview(false)}
                        />
                    )}
                    
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <h1 className="text-2xl font-bold text-gray-900">Staff Dashboard</h1>
                            <p className="text-sm text-gray-600">Schedule and manage visitor appointments</p>
                        </div>
                    </div>

                    <div className="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                        <div className="bg-white rounded-lg shadow p-8">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-semibold text-gray-900">Schedule New Visit</h2>
                                <button
                                    onClick={() => setShowScheduleForm(!showScheduleForm)}
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                >
                                    {showScheduleForm ? 'Cancel' : '+ New Visit'}
                                </button>
                            </div>

                            {showScheduleForm && (
                                <form onSubmit={handleSubmit} className="space-y-6">
                                    {/* Visit Type Selection */}
                                    <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                                        <label className="block text-sm font-medium text-gray-700 mb-3">Visit Type *</label>
                                        <div className="grid grid-cols-2 gap-4">
                                            <button
                                                type="button"
                                                onClick={() => setFormData({...formData, visitType: 'scheduled'})}
                                                className={`px-4 py-3 rounded-lg border-2 transition-all ${
                                                    formData.visitType === 'scheduled' 
                                                    ? 'border-indigo-600 bg-indigo-50 text-indigo-700 font-semibold' 
                                                    : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400'
                                                }`}
                                            >
                                                <div className="flex items-center justify-center space-x-2">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                    </svg>
                                                    <span>Scheduled Appointment</span>
                                                </div>
                                                <p className="text-xs mt-1 opacity-75">Pre-planned visit</p>
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => setFormData({...formData, visitType: 'walk_in'})}
                                                className={`px-4 py-3 rounded-lg border-2 transition-all ${
                                                    formData.visitType === 'walk_in' 
                                                    ? 'border-purple-600 bg-purple-50 text-purple-700 font-semibold' 
                                                    : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400'
                                                }`}
                                            >
                                                <div className="flex items-center justify-center space-x-2">
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                                    </svg>
                                                    <span>Walk-in Visitor</span>
                                                </div>
                                                <p className="text-xs mt-1 opacity-75">Already here now</p>
                                            </button>
                                        </div>
                                    </div>

                                    {/* Visitor Information */}
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Visitor Information</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Visitor Name *</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={formData.visitorName}
                                                    onChange={(e) => setFormData({...formData, visitorName: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    placeholder="John Doe"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Company</label>
                                                <input
                                                    type="text"
                                                    value={formData.company}
                                                    onChange={(e) => setFormData({...formData, company: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    placeholder="ABC Corporation"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                                                <input
                                                    type="tel"
                                                    required
                                                    value={formData.phone}
                                                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    placeholder="+92-300-1234567"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                                <input
                                                    type="email"
                                                    value={formData.email}
                                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    placeholder="visitor@example.com"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Meeting Details */}
                                    <div>
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4">Meeting Details</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Meeting With (Executive) *</label>
                                                <select
                                                    required
                                                    value={formData.executiveId}
                                                    onChange={(e) => setFormData({...formData, executiveId: e.target.value})}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                >
                                                    {EXECUTIVES.map(exec => (
                                                        <option key={exec.id} value={exec.id}>
                                                            {exec.name} - {exec.position}
                                                        </option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">Purpose of Visit *</label>
                                                <textarea
                                                    required
                                                    value={formData.purpose}
                                                    onChange={(e) => setFormData({...formData, purpose: e.target.value})}
                                                    rows={3}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    placeholder="Business meeting, document submission, etc."
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Date & Time - Only show for scheduled visits */}
                                    {formData.visitType === 'scheduled' && (
                                        <div>
                                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Schedule Date & Time</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                                                    <input
                                                        type="date"
                                                        required
                                                        value={formData.date}
                                                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                                                        min={new Date().toISOString().split('T')[0]}
                                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">From *</label>
                                                    <input
                                                        type="time"
                                                        required
                                                        value={formData.timeFrom}
                                                        onChange={(e) => setFormData({...formData, timeFrom: e.target.value})}
                                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">To *</label>
                                                    <input
                                                        type="time"
                                                        required
                                                        value={formData.timeTo}
                                                        onChange={(e) => setFormData({...formData, timeTo: e.target.value})}
                                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Walk-in Info Notice */}
                                    {formData.visitType === 'walk_in' && (
                                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                            <div className="flex items-start">
                                                <svg className="w-5 h-5 text-purple-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                <div>
                                                    <p className="text-sm font-medium text-purple-900">Walk-in Visitor Registration</p>
                                                    <p className="text-sm text-purple-700 mt-1">
                                                        Visit will be registered for <strong>today</strong> at the <strong>current time</strong>. 
                                                        The executive will be immediately notified for approval.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex justify-end space-x-4 pt-4 border-t">
                                        <button
                                            type="button"
                                            onClick={() => setShowScheduleForm(false)}
                                            className="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className={`px-6 py-2 text-white rounded-lg transition-colors font-medium ${
                                                formData.visitType === 'walk_in' 
                                                ? 'bg-purple-600 hover:bg-purple-700' 
                                                : 'bg-indigo-600 hover:bg-indigo-700'
                                            }`}
                                        >
                                            {formData.visitType === 'walk_in' ? 'Register Walk-in' : 'Schedule Visit'}
                                        </button>
                                    </div>
                                </form>
                            )}

                            {!showScheduleForm && (
                                <div className="text-center py-12">
                                    <svg className="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <h3 className="text-lg font-medium text-gray-900 mb-2">Schedule a visitor appointment</h3>
                                    <p className="text-gray-600 mb-4">Click the "New Visit" button to schedule an appointment for an executive</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const QRScanner = ({ onScanSuccess, onScanError }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [isScanning, setIsScanning] = useState(false);
            const [hasPermission, setHasPermission] = useState(null);
            const [devices, setDevices] = useState([]);
            const [selectedDevice, setSelectedDevice] = useState('');
            const [scanError, setScanError] = useState('');

            useEffect(() => {
                // Get camera devices
                const getDevices = async () => {
                    try {
                        // Check if mediaDevices API is available
                        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                            setScanError('Camera API not supported in this browser');
                            return;
                        }
                        
                        // Request permission first to get device labels
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        stream.getTracks().forEach(track => track.stop());
                        
                        const deviceInfos = await navigator.mediaDevices.enumerateDevices();
                        const videoDevices = deviceInfos.filter(device => device.kind === 'videoinput');
                        setDevices(videoDevices);
                        if (videoDevices.length > 0) {
                            setSelectedDevice(videoDevices[0].deviceId);
                        }
                    } catch (err) {
                        console.error('Error getting devices:', err);
                        const errorMsg = err.name === 'NotAllowedError' 
                            ? 'Camera permission denied. Please enable camera access in your browser settings.'
                            : 'Unable to access camera devices';
                        setScanError(errorMsg);
                    }
                };

                getDevices();
            }, []);

            const startCamera = async () => {
                try {
                    setScanError('');
                    
                    // Request camera permission
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            deviceId: selectedDevice ? { exact: selectedDevice } : undefined,
                            facingMode: 'environment' // Prefer back camera on mobile
                        } 
                    });
                    
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.play();
                        setHasPermission(true);
                        setIsScanning(true);
                        scanQRCode();
                    }
                } catch (err) {
                    console.error('Camera error:', err);
                    setHasPermission(false);
                    const errorMsg = err.name === 'NotAllowedError' 
                        ? 'Camera permission denied. Please enable camera access in your browser settings.'
                        : 'Camera not available or permission denied';
                    setScanError(errorMsg);
                    if (onScanError) {
                        onScanError(errorMsg);
                    }
                }
            };

            const stopCamera = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    const stream = videoRef.current.srcObject;
                    const tracks = stream.getTracks();
                    tracks.forEach(track => track.stop());
                    videoRef.current.srcObject = null;
                }
                setIsScanning(false);
            };

            const scanQRCode = () => {
                if (!videoRef.current || !canvasRef.current || !isScanning) return;

                const canvas = canvasRef.current;
                const video = videoRef.current;
                const canvasContext = canvas.getContext('2d');

                const scan = () => {
                    if (!isScanning || !video.videoWidth || !video.videoHeight) {
                        requestAnimationFrame(scan);
                        return;
                    }

                    try {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

                        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            stopCamera();
                            if (onScanSuccess) {
                                onScanSuccess(code.data);
                            }
                        } else {
                            requestAnimationFrame(scan);
                        }
                    } catch (err) {
                        console.error('QR scan error:', err);
                        requestAnimationFrame(scan);
                    }
                };

                requestAnimationFrame(scan);
            };

            useEffect(() => {
                if (isScanning) {
                    scanQRCode();
                }
            }, [isScanning]);

            useEffect(() => {
                return () => {
                    stopCamera();
                };
            }, []);

            return (
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="text-center mb-6">
                        <h3 className="text-lg font-semibold text-gray-900 mb-2">Camera QR Scanner</h3>
                        <p className="text-sm text-gray-600">Point your camera at the QR code</p>
                    </div>

                    {(hasPermission === false || scanError) && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <div className="flex items-center">
                                <svg className="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <p className="text-sm font-medium text-red-900">Camera Access Denied</p>
                                    <p className="text-sm text-red-700 mt-1">{scanError || 'Please enable camera permissions in your browser settings.'}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {devices.length > 1 && (
                        <div className="mb-4">
                            <label className="block text-sm font-medium text-gray-700 mb-2">Select Camera</label>
                            <select
                                value={selectedDevice}
                                onChange={(e) => setSelectedDevice(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                            >
                                {devices.map(device => (
                                    <option key={device.deviceId} value={device.deviceId}>
                                        {device.label || `Camera ${devices.indexOf(device) + 1}`}
                                    </option>
                                ))}
                            </select>
                        </div>
                    )}

                    <div className="relative mb-4">
                        <video
                            ref={videoRef}
                            className={`w-full rounded-lg ${isScanning ? 'block' : 'hidden'}`}
                            playsInline
                            muted
                        />
                        <canvas
                            ref={canvasRef}
                            className="hidden"
                        />
                        
                        {!isScanning && (
                            <div className="bg-gray-100 rounded-lg p-12 text-center">
                                <svg className="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <p className="text-gray-600">Camera ready</p>
                            </div>
                        )}
                    </div>

                    <div className="flex space-x-3">
                        {!isScanning ? (
                            <button
                                onClick={startCamera}
                                disabled={!selectedDevice}
                                className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                            >
                                Start Camera
                            </button>
                        ) : (
                            <button
                                onClick={stopCamera}
                                className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                            >
                                Stop Camera
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const GuardDashboard = () => {
            const [view, setView] = useState('scanner');
            const [scanInput, setScanInput] = useState('');
            const [scanResult, setScanResult] = useState(null);
            const [showWalkInForm, setShowWalkInForm] = useState(false);
            const [showPassPreview, setShowPassPreview] = useState(false);
            const [createdVisit, setCreatedVisit] = useState(null);
            const [todayVisits, setTodayVisits] = useState([]);
            const [walkInData, setWalkInData] = useState({
                name: '',
                company: '',
                phone: '',
                executiveId: '',
                purpose: ''
            });

            useEffect(() => {
                const loadVisits = async () => {
                    const visits = await getVisits();
                    const today = new Date().toISOString().split('T')[0];
                    setTodayVisits(visits.filter(v => v.date === today));
                };
                loadVisits();
            }, []);

            // Set first executive as default when executives list is loaded
            useEffect(() => {
                if (EXECUTIVES.length > 0 && !walkInData.executiveId) {
                    setWalkInData(prev => ({...prev, executiveId: EXECUTIVES[0].id}));
                }
            }, [EXECUTIVES.length]);

            const handleScan = async (code = null) => {
                const inputCode = code || scanInput;
                if (!inputCode || typeof inputCode !== 'string') {
                    setScanResult({ valid: false, message: 'Please enter a valid visit code' });
                    return;
                }
                
                const scanCode = inputCode.trim().toUpperCase();
                if (!scanCode) {
                    setScanResult({ valid: false, message: 'Please enter a visit code' });
                    return;
                }
                
                const visits = await getVisits();
                const visit = visits.find(v => v.code.toUpperCase() === scanCode);
                
                if (!visit) {
                    setScanResult({ valid: false, message: 'Invalid visit code' });
                    return;
                }

                if (visit.approval !== 'approved') {
                    setScanResult({ valid: false, message: 'Visit not approved yet by executive. Please contact the executive or wait for approval.', visit });
                    return;
                }

                if (visit.status === 'checked_in') {
                    setScanResult({ valid: false, message: 'Visitor already checked in', visit });
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                if (visit.date !== today) {
                    setScanResult({ valid: false, message: 'Visit not scheduled for today', visit });
                    return;
                }

                setScanResult({ valid: true, visit });
            };

            const handleQRScanSuccess = (qrData) => {
                setScanInput(qrData);
                handleScan(qrData);
            };

            const handleQRScanError = (error) => {
                setScanResult({ valid: false, message: error });
            };

            const handleCheckIn = async () => {
                if (scanResult && scanResult.visit) {
                    try {
                        const response = await fetch(`/api/visits/${scanResult.visit.id}/checkin`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Check-in failed');
                        }

                        alert('Visitor checked in successfully!');
                        setScanInput('');
                        setScanResult(null);
                        
                        // Reload today's visits
                        const visits = await getVisits();
                        const today = new Date().toISOString().split('T')[0];
                        setTodayVisits(visits.filter(v => v.date === today));
                    } catch (error) {
                        console.error('Check-in error:', error);
                        alert('Failed to check in visitor. Please try again.');
                    }
                }
            };

            const handleWalkInSubmit = async (e) => {
                e.preventDefault();
                
                const visit = {
                    id: Date.now(),
                    code: null, // Will be set from database
                    visitor: {
                        name: walkInData.name,
                        company: walkInData.company,
                        phone: walkInData.phone
                    },
                    executiveId: walkInData.executiveId,
                    purpose: walkInData.purpose,
                    date: new Date().toISOString().split('T')[0],
                    timeFrom: new Date().toTimeString().split(' ')[0].substring(0, 5),
                    timeTo: new Date(Date.now() + 3600000).toTimeString().split(' ')[0].substring(0, 5),
                    status: 'scheduled',
                    approval: 'pending',
                    type: 'walk_in',
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const result = await saveVisit(visit);
                    
                    console.log('=== Security Guard Dashboard - After Save ===');
                    console.log('Result.visit_code:', result?.visit_code);
                    
                    // Create new visit object with database-generated code
                    // API returns visit object directly with visit_code property
                    if (result && result.visit_code) {
                        const visitWithCode = {
                            ...visit,
                            code: result.visit_code,
                            id: result.id
                        };
                        console.log('Security Guard - visitWithCode.code:', visitWithCode.code);
                        
                        // Show digital pass preview with database code
                        setCreatedVisit(visitWithCode);
                    } else {
                        setCreatedVisit(visit);
                    }
                    
                    setShowPassPreview(true);
                    setShowWalkInForm(false);
                    setWalkInData({ name: '', company: '', phone: '', executiveId: '', purpose: '' });
                } catch (error) {
                    console.error('Failed to register walk-in visitor:', error);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {showPassPreview && createdVisit && (
                        <DigitalPass 
                            visit={createdVisit}
                            executive={EXECUTIVES.find(e => e.id === createdVisit.executiveId)}
                            onClose={() => setShowPassPreview(false)}
                        />
                    )}
                    
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <h1 className="text-2xl font-bold text-gray-900">Security Guard Dashboard</h1>
                            <p className="text-sm text-gray-600">QR Scanner & Visitor Management</p>
                        </div>
                    </div>

                    <div className="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                        {/* Tab Navigation */}
                        <div className="bg-white rounded-lg shadow mb-6">
                            <div className="flex border-b">
                                <button
                                    onClick={() => setView('scanner')}
                                    className={`flex-1 px-6 py-4 text-center font-medium transition-colors ${view === 'scanner' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-900'}`}
                                >
                                    QR Scanner
                                </button>
                                <button
                                    onClick={() => setView('walkin')}
                                    className={`flex-1 px-6 py-4 text-center font-medium transition-colors ${view === 'walkin' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-900'}`}
                                >
                                    Walk-in Registration
                                </button>
                                <button
                                    onClick={() => setView('list')}
                                    className={`flex-1 px-6 py-4 text-center font-medium transition-colors ${view === 'list' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-gray-900'}`}
                                >
                                    Today's Visitors
                                </button>
                            </div>
                        </div>

                        {/* QR Scanner View */}
                        {view === 'scanner' && (
                            <div className="space-y-6">
                                {/* Camera QR Scanner */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="text-center mb-6">
                                        <div className="bg-indigo-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                            <svg className="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-lg font-semibold text-gray-900">Camera QR Scanner</h3>
                                        <p className="text-sm text-gray-600">Use your device camera to scan QR codes</p>
                                    </div>
                                    
                                    <QRScanner 
                                        onScanSuccess={handleQRScanSuccess}
                                        onScanError={handleQRScanError}
                                    />
                                </div>

                                {/* Manual Code Entry */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="text-center mb-6">
                                        <div className="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                                            <svg className="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                                            </svg>
                                        </div>
                                        <h3 className="text-lg font-semibold text-gray-900">Manual Code Entry</h3>
                                        <p className="text-sm text-gray-600">Type the visit code manually</p>
                                    </div>

                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Visit Code</label>
                                            <input
                                                type="text"
                                                value={scanInput}
                                                onChange={(e) => setScanInput(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && handleScan()}
                                                placeholder="GC-2025-000001"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-lg font-mono"
                                            />
                                        </div>
                                        <button
                                            onClick={() => handleScan()}
                                            className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium text-lg"
                                        >
                                            Validate Pass
                                        </button>
                                    </div>
                                </div>

                                {/* Scan Results */}
                                {scanResult && (
                                    <div className={`p-6 rounded-lg ${scanResult.valid ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500'}`}>
                                        <div className="flex items-center mb-4">
                                            {scanResult.valid ? (
                                                <svg className="w-8 h-8 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            ) : (
                                                <svg className="w-8 h-8 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            )}
                                            <h3 className={`text-xl font-bold ${scanResult.valid ? 'text-green-900' : 'text-red-900'}`}>
                                                {scanResult.valid ? '✓ VALID PASS' : '✗ INVALID PASS'}
                                            </h3>
                                        </div>
                                        <p className={`mb-4 ${scanResult.valid ? 'text-green-800' : 'text-red-800'}`}>
                                            {scanResult.message || 'Visitor can proceed to check-in'}
                                        </p>

                                        {scanResult.visit && (
                                            <div className="bg-white rounded-lg p-4 space-y-2">
                                                <div><span className="font-semibold">Visitor:</span> {scanResult.visit.visitor.name}</div>
                                                <div><span className="font-semibold">Company:</span> {scanResult.visit.visitor.company}</div>
                                                <div><span className="font-semibold">Executive:</span> {EXECUTIVES.find(e => e.id === scanResult.visit.executiveId)?.name}</div>
                                                <div><span className="font-semibold">Purpose:</span> {scanResult.visit.purpose}</div>
                                                <div><span className="font-semibold">Time:</span> {scanResult.visit.timeFrom} - {scanResult.visit.timeTo}</div>
                                            </div>
                                        )}

                                        {scanResult.valid && (
                                            <button
                                                onClick={handleCheckIn}
                                                className="w-full mt-4 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                                            >
                                                ✓ Check In Visitor
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Walk-in Registration */}
                        {view === 'walkin' && (
                            <div className="bg-white rounded-lg shadow p-8">
                                <h2 className="text-2xl font-bold text-gray-900 mb-6">Register Walk-in Visitor</h2>
                                <form onSubmit={handleWalkInSubmit} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Visitor Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={walkInData.name}
                                            onChange={(e) => setWalkInData({...walkInData, name: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="Enter visitor name"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Company</label>
                                        <input
                                            type="text"
                                            value={walkInData.company}
                                            onChange={(e) => setWalkInData({...walkInData, company: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="Company name"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Phone *</label>
                                        <input
                                            type="tel"
                                            required
                                            value={walkInData.phone}
                                            onChange={(e) => setWalkInData({...walkInData, phone: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="+92-300-1234567"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Meeting With *</label>
                                        <select
                                            required
                                            value={walkInData.executiveId}
                                            onChange={(e) => setWalkInData({...walkInData, executiveId: e.target.value})}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                        >
                                            {EXECUTIVES.map(exec => (
                                                <option key={exec.id} value={exec.id}>
                                                    {exec.name} - {exec.position}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Purpose *</label>
                                        <textarea
                                            required
                                            value={walkInData.purpose}
                                            onChange={(e) => setWalkInData({...walkInData, purpose: e.target.value})}
                                            rows={3}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                            placeholder="Purpose of visit"
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        className="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                                    >
                                        Register & Notify Executive
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* Today's Visitors List */}
                        {view === 'list' && (
                            <div className="bg-white rounded-lg shadow">
                                <div className="px-6 py-4 border-b">
                                    <h2 className="text-xl font-semibold text-gray-900">Today's Expected Visitors</h2>
                                    <p className="text-sm text-gray-600 mt-1">{todayVisits.length} visitors scheduled</p>
                                </div>
                                <div className="divide-y">
                                    {todayVisits.length === 0 ? (
                                        <div className="p-8 text-center text-gray-500">
                                            No visitors scheduled for today
                                        </div>
                                    ) : (
                                        todayVisits.map(visit => (
                                            <div key={visit.id} className="p-6">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <h3 className="font-semibold text-lg text-gray-900">{visit.visitor.name}</h3>
                                                        <p className="text-sm text-gray-600">{visit.visitor.company}</p>
                                                        <p className="text-sm text-gray-700 mt-2">
                                                            <span className="font-medium">Meeting:</span> {EXECUTIVES.find(e => e.id === visit.executiveId)?.name}
                                                        </p>
                                                        <p className="text-sm text-gray-700">
                                                            <span className="font-medium">Time:</span> {visit.timeFrom} - {visit.timeTo}
                                                        </p>
                                                        <p className="text-xs text-gray-500 mt-1">Code: {visit.code}</p>
                                                    </div>
                                                    <span className={`px-3 py-1 text-xs font-medium rounded-full ${
                                                        visit.status === 'checked_in' ? 'bg-green-100 text-green-800' :
                                                        visit.approval === 'approved' ? 'bg-blue-100 text-blue-800' :
                                                        'bg-yellow-100 text-yellow-800'
                                                    }`}>
                                                        {visit.status === 'checked_in' ? 'CHECKED IN' :
                                                         visit.approval === 'approved' ? 'APPROVED' : 'PENDING'}
                                                    </span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AdminDashboard = () => {
            const [visits, setVisits] = useState([]);
            const [stats, setStats] = useState({});
            const [users, setUsers] = useState([]);
            const [systemSettings, setSystemSettings] = useState({
                autoApproveWalkIns: true,
                requirePhoto: false,
                maxDailyVisits: 50,
                qrCodeExpiry: 24
            });
            const [activeTab, setActiveTab] = useState('overview');

            useEffect(() => {
                const loadVisits = async () => {
                    const allVisits = await getVisits();
                    setVisits(allVisits);

                    const today = new Date().toISOString().split('T')[0];
                    const todayVisits = allVisits.filter(v => v.date === today);
                    const thisWeek = allVisits.filter(v => {
                        const visitDate = new Date(v.date);
                        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        return visitDate >= weekAgo;
                    });

                    setStats({
                        total: allVisits.length,
                        today: todayVisits.length,
                        thisWeek: thisWeek.length,
                        pending: allVisits.filter(v => v.approval === 'pending').length,
                        checkedIn: todayVisits.filter(v => v.status === 'checked_in').length,
                        approved: allVisits.filter(v => v.approval === 'approved').length,
                        walkIns: allVisits.filter(v => v.type === 'walk_in').length,
                        scheduled: allVisits.filter(v => v.type === 'scheduled').length
                    });
                };
                loadVisits();

                // Load system settings from localStorage
                const savedSettings = localStorage.getItem('guestpass_settings');
                if (savedSettings) {
                    try {
                        setSystemSettings(JSON.parse(savedSettings));
                    } catch (e) {
                        console.error('Error loading settings:', e);
                    }
                }

                // Load users from localStorage (mock user management)
                const savedUsers = localStorage.getItem('guestpass_users');
                if (savedUsers) {
                    try {
                        setUsers(JSON.parse(savedUsers));
                    } catch (e) {
                        console.error('Error loading users:', e);
                    }
                } else {
                    // Initialize with default users
                    const defaultUsers = [
                        { id: 1, username: 'admin', name: 'System Administrator', role: 'admin', active: true, lastLogin: new Date().toISOString() },
                        { id: 2, username: 'guard1', name: 'Security Guard 1', role: 'guard', active: true, lastLogin: null },
                        { id: 3, username: 'staff1', name: 'Staff Member 1', role: 'staff', active: true, lastLogin: null }
                    ];
                    setUsers(defaultUsers);
                    localStorage.setItem('guestpass_users', JSON.stringify(defaultUsers));
                }
            }, []);

            const executiveStats = EXECUTIVES.map(exec => {
                const execVisits = visits.filter(v => v.executiveId === exec.id);
                return {
                    executive: exec,
                    total: execVisits.length,
                    pending: execVisits.filter(v => v.approval === 'pending').length,
                    today: execVisits.filter(v => v.date === new Date().toISOString().split('T')[0]).length,
                    approved: execVisits.filter(v => v.approval === 'approved').length
                };
            });

            const handleSettingsChange = (key, value) => {
                const newSettings = { ...systemSettings, [key]: value };
                setSystemSettings(newSettings);
                localStorage.setItem('guestpass_settings', JSON.stringify(newSettings));
            };

            const toggleUserStatus = (userId) => {
                const updatedUsers = users.map(user => 
                    user.id === userId ? { ...user, active: !user.active } : user
                );
                setUsers(updatedUsers);
                localStorage.setItem('guestpass_users', JSON.stringify(updatedUsers));
            };

            const exportData = () => {
                const data = {
                    visits: visits,
                    stats: stats,
                    settings: systemSettings,
                    exportDate: new Date().toISOString()
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `guestpass-export-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
                                    <p className="text-sm text-gray-600">System-wide analytics and management</p>
                                </div>
                                <button
                                    onClick={exportData}
                                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Admin Navigation Tabs */}
                    <div className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <nav className="flex space-x-8">
                                {[
                                    { id: 'overview', name: 'Overview', icon: '📊' },
                                    { id: 'users', name: 'Users', icon: '👥' },
                                    { id: 'settings', name: 'Settings', icon: '⚙️' },
                                    { id: 'analytics', name: 'Analytics', icon: '📈' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`py-4 px-1 border-b-2 font-medium text-sm ${
                                            activeTab === tab.id
                                                ? 'border-indigo-500 text-indigo-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                        }`}
                                    >
                                        <span className="mr-2">{tab.icon}</span>
                                        {tab.name}
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
                        {activeTab === 'overview' && (
                            <>
                                {/* System Stats */}
                                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="text-sm text-gray-600 mb-1">Total Visits</div>
                                        <div className="text-3xl font-bold text-gray-900">{stats.total || 0}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="text-sm text-gray-600 mb-1">Today</div>
                                        <div className="text-3xl font-bold text-indigo-600">{stats.today || 0}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="text-sm text-gray-600 mb-1">This Week</div>
                                        <div className="text-3xl font-bold text-blue-600">{stats.thisWeek || 0}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="text-sm text-gray-600 mb-1">Walk-ins</div>
                                        <div className="text-3xl font-bold text-purple-600">{stats.walkIns || 0}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="text-sm text-gray-600 mb-1">Scheduled</div>
                                        <div className="text-3xl font-bold text-green-600">{stats.scheduled || 0}</div>
                                    </div>
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="text-sm text-gray-600 mb-1">Pending</div>
                                        <div className="text-3xl font-bold text-orange-600">{stats.pending || 0}</div>
                                    </div>
                                </div>

                                {/* Executive Breakdown */}
                                <div className="bg-white rounded-lg shadow mb-8">
                                    <div className="px-6 py-4 border-b">
                                        <h2 className="text-xl font-semibold text-gray-900">Per-Executive Statistics</h2>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Executive</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Position</th>
                                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Total Visits</th>
                                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Today</th>
                                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pending</th>
                                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Approved</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {executiveStats.map(stat => (
                                                    <tr key={stat.executive.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <div className="font-medium text-gray-900">{stat.executive.name}</div>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                            {stat.executive.position}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold text-gray-900">
                                                            {stat.total}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-center">
                                                            <span className="px-2 py-1 text-sm font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                                                {stat.today}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-center">
                                                            {stat.pending > 0 ? (
                                                                <span className="px-2 py-1 text-sm font-semibold rounded-full bg-orange-100 text-orange-800">
                                                                    {stat.pending}
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400">0</span>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-center">
                                                            <span className="px-2 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                                                                {stat.approved}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        )}

                        {activeTab === 'users' && (
                            <div className="bg-white rounded-lg shadow">
                                <div className="px-6 py-4 border-b">
                                    <h2 className="text-xl font-semibold text-gray-900">User Management</h2>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Login</th>
                                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {users.map(user => (
                                                <tr key={user.id} className="hover:bg-gray-50">
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <div className="font-medium text-gray-900">{user.name}</div>
                                                        <div className="text-sm text-gray-600">{user.username}</div>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                                            user.role === 'admin' ? 'bg-red-100 text-red-800' :
                                                            user.role === 'guard' ? 'bg-blue-100 text-blue-800' :
                                                            user.role === 'staff' ? 'bg-green-100 text-green-800' :
                                                            'bg-gray-100 text-gray-800'
                                                        }`}>
                                                            {user.role.toUpperCase()}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                                            user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                        }`}>
                                                            {user.active ? 'Active' : 'Inactive'}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        {user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never'}
                                                    </td>
                                                    <td className="px-6 py-4 whitespace-nowrap">
                                                        <button
                                                            onClick={() => toggleUserStatus(user.id)}
                                                            className={`px-3 py-1 text-xs font-medium rounded ${
                                                                user.active 
                                                                    ? 'bg-red-100 text-red-800 hover:bg-red-200' 
                                                                    : 'bg-green-100 text-green-800 hover:bg-green-200'
                                                            }`}
                                                        >
                                                            {user.active ? 'Deactivate' : 'Activate'}
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="bg-white rounded-lg shadow">
                                <div className="px-6 py-4 border-b">
                                    <h2 className="text-xl font-semibold text-gray-900">System Settings</h2>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label className="flex items-center space-x-3">
                                                <input
                                                    type="checkbox"
                                                    checked={systemSettings.autoApproveWalkIns}
                                                    onChange={(e) => handleSettingsChange('autoApproveWalkIns', e.target.checked)}
                                                    className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                />
                                                <span className="text-gray-700">Auto-approve walk-in visitors</span>
                                            </label>
                                            <p className="text-sm text-gray-500 mt-1">Walk-in visitors will be automatically approved</p>
                                        </div>

                                        <div>
                                            <label className="flex items-center space-x-3">
                                                <input
                                                    type="checkbox"
                                                    checked={systemSettings.requirePhoto}
                                                    onChange={(e) => handleSettingsChange('requirePhoto', e.target.checked)}
                                                    className="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                />
                                                <span className="text-gray-700">Require visitor photo</span>
                                            </label>
                                            <p className="text-sm text-gray-500 mt-1">Visitors must upload a photo for their pass</p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Maximum daily visits
                                            </label>
                                            <input
                                                type="number"
                                                value={systemSettings.maxDailyVisits}
                                                onChange={(e) => handleSettingsChange('maxDailyVisits', parseInt(e.target.value))}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                min="1"
                                                max="200"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                QR Code expiry (hours)
                                            </label>
                                            <input
                                                type="number"
                                                value={systemSettings.qrCodeExpiry}
                                                onChange={(e) => handleSettingsChange('qrCodeExpiry', parseInt(e.target.value))}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                min="1"
                                                max="168"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h2 className="text-xl font-semibold text-gray-900 mb-4">Visit Trends</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="text-center p-4 bg-blue-50 rounded-lg">
                                            <div className="text-2xl font-bold text-blue-600">{stats.today || 0}</div>
                                            <div className="text-sm text-blue-800">Today's Visits</div>
                                        </div>
                                        <div className="text-center p-4 bg-green-50 rounded-lg">
                                            <div className="text-2xl font-bold text-green-600">{stats.approved || 0}</div>
                                            <div className="text-sm text-green-800">Total Approved</div>
                                        </div>
                                        <div className="text-center p-4 bg-purple-50 rounded-lg">
                                            <div className="text-2xl font-bold text-purple-600">{stats.walkIns || 0}</div>
                                            <div className="text-sm text-purple-800">Walk-ins</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Recent Activity */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="px-6 py-4 border-b">
                                        <h2 className="text-xl font-semibold text-gray-900">Recent Activity</h2>
                                    </div>
                                    <div className="divide-y divide-gray-200 max-h-96 overflow-y-auto">
                                        {visits.slice(0, 30).map(visit => (
                                            <div key={visit.id} className="p-4 hover:bg-gray-50">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="flex items-center space-x-2">
                                                            <span className="font-semibold text-gray-900">{visit.visitor.name}</span>
                                                            <span className="text-sm text-gray-600">→</span>
                                                            <span className="text-sm text-gray-700">{EXECUTIVES.find(e => e.id === visit.executiveId)?.name}</span>
                                                        </div>
                                                        <div className="text-sm text-gray-600 mt-1">
                                                            {visit.visitor.company} • {visit.date} at {visit.timeFrom}
                                                        </div>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                                            visit.type === 'walk_in' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                                                        }`}>
                                                            {visit.type === 'walk_in' ? 'Walk-in' : 'Scheduled'}
                                                        </span>
                                                        <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                                            visit.approval === 'approved' ? 'bg-green-100 text-green-800' :
                                                            visit.approval === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                                            'bg-red-100 text-red-800'
                                                        }`}>
                                                            {visit.approval}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Receptionist Dashboard with enhanced validation capabilities
        const ReceptionistDashboard = () => {
            const [showWalkInForm, setShowWalkInForm] = useState(false);
            const [showPassPreview, setShowPassPreview] = useState(false);
            const [createdVisit, setCreatedVisit] = useState(null);
            const [walkInData, setWalkInData] = useState({
                name: '',
                company: '',
                phone: '',
                executiveId: '',
                purpose: ''
            });
            const [scanInput, setScanInput] = useState('');
            const [scanResult, setScanResult] = useState(null);
            const [todayVisits, setTodayVisits] = useState([]);

            useEffect(() => {
                const loadVisits = async () => {
                    const visits = await getVisits();
                    const today = new Date().toISOString().split('T')[0];
                    setTodayVisits(visits.filter(v => v.date === today));
                };
                loadVisits();
            }, []);

            // Set first executive as default when executives list is loaded
            useEffect(() => {
                if (EXECUTIVES.length > 0 && !walkInData.executiveId) {
                    setWalkInData(prev => ({...prev, executiveId: EXECUTIVES[0].id}));
                }
            }, [EXECUTIVES.length]);

            const handleWalkInSubmit = async (e) => {
                e.preventDefault();
                
                const visit = {
                    id: Date.now(),
                    code: null, // Will be set from database
                    visitor: { name: walkInData.name, company: walkInData.company, phone: walkInData.phone },
                    executiveId: walkInData.executiveId,
                    purpose: walkInData.purpose,
                    date: new Date().toISOString().split('T')[0],
                    timeFrom: new Date().toTimeString().split(' ')[0].substring(0, 5),
                    timeTo: new Date(Date.now() + 3600000).toTimeString().split(' ')[0].substring(0, 5),
                    status: 'scheduled',
                    approval: 'pending',
                    type: 'walk_in',
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const result = await saveVisit(visit);
                    
                    console.log('=== Receptionist Dashboard - After Save ===');
                    console.log('Result.visit_code:', result?.visit_code);
                    
                    // Create new visit object with database-generated code
                    // API returns visit object directly with visit_code property
                    if (result && result.visit_code) {
                        const visitWithCode = {
                            ...visit,
                            code: result.visit_code,
                            id: result.id
                        };
                        console.log('Receptionist - visitWithCode.code:', visitWithCode.code);
                        
                        // Show digital pass preview with database code
                        setCreatedVisit(visitWithCode);
                    } else {
                        setCreatedVisit(visit);
                    }
                    
                    setShowPassPreview(true);
                    setShowWalkInForm(false);
                    setWalkInData({ name: '', company: '', phone: '', executiveId: '', purpose: '' });
                } catch (error) {
                    console.error('Failed to save walk-in visit:', error);
                }
            };

            const handleValidatePass = async () => {
                const code = scanInput.trim().toUpperCase();
                const visits = await getVisits();
                const visit = visits.find(v => v.code.toUpperCase() === code);
                
                if (!visit) {
                    setScanResult({ valid: false, message: 'Invalid pass code' });
                    return;
                }

                if (visit.approval !== 'approved') {
                    setScanResult({ valid: false, message: 'Visit not approved yet by executive. Please contact the executive or wait for approval.', visit });
                    return;
                }

                if (visit.status === 'checked_in') {
                    setScanResult({ valid: false, message: 'Visitor already checked in', visit });
                    return;
                }

                if (visit.status === 'checked_out') {
                    setScanResult({ valid: false, message: 'Visitor already checked out', visit });
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                if (visit.date !== today) {
                    setScanResult({ valid: false, message: 'Pass not valid for today', visit });
                    return;
                }

                setScanResult({ valid: true, visit });
            };

            const handleCheckIn = async () => {
                if (scanResult && scanResult.visit) {
                    await updateVisit(scanResult.visit.id, {
                        status: 'checked_in',
                        checkinTime: new Date().toISOString()
                    });
                    setScanResult({ valid: true, visit: { ...scanResult.visit, status: 'checked_in' }, message: 'Check-in successful!' });
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {showPassPreview && createdVisit && (
                        <DigitalPass 
                            visit={createdVisit}
                            executive={EXECUTIVES.find(e => e.id === createdVisit.executiveId)}
                            onClose={() => setShowPassPreview(false)}
                        />
                    )}
                    
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
                            <h1 className="text-2xl font-bold text-gray-900">Receptionist Dashboard</h1>
                            <p className="text-sm text-gray-600">Walk-in Registration & Pass Validation</p>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Quick Actions */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-lg shadow p-6 mb-6">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
                                    <button
                                        onClick={() => setShowWalkInForm(true)}
                                        className="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium mb-3"
                                    >
                                        Register Walk-in Visitor
                                    </button>
                                    <button
                                        onClick={() => setShowScanner(true)}
                                        className="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
                                    >
                                        Validate Visitor Pass
                                    </button>
                                </div>

                                {/* Pass Validation */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h2 className="text-lg font-semibold text-gray-900 mb-4">Validate Pass</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Visit Code</label>
                                            <input
                                                type="text"
                                                value={scanInput}
                                                onChange={(e) => setScanInput(e.target.value)}
                                                placeholder="Enter visit code (e.g., GC-2025-000001)"
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
                                            />
                                        </div>
                                        <button
                                            onClick={handleValidatePass}
                                            className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                        >
                                            Validate Pass
                                        </button>

                                        {scanResult && (
                                            <div className={`p-3 rounded-lg ${
                                                scanResult.valid ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'
                                            }`}>
                                                <p className={`text-sm font-medium ${
                                                    scanResult.valid ? 'text-green-800' : 'text-red-800'
                                                }`}>
                                                    {scanResult.message}
                                                </p>
                                                {scanResult.valid && scanResult.visit && (
                                                    <button
                                                        onClick={handleCheckIn}
                                                        className="w-full mt-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                                                    >
                                                        Check In Visitor
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Today's Visitors */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-lg shadow">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <h2 className="text-lg font-semibold text-gray-900">Today's Visitors</h2>
                                    </div>
                                    <div className="divide-y divide-gray-200">
                                        {todayVisits.length === 0 ? (
                                            <div className="p-6 text-center text-gray-500">
                                                <svg className="w-12 h-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                </svg>
                                                <p>No visitors registered for today</p>
                                            </div>
                                        ) : (
                                            todayVisits.map(visit => (
                                                <div key={visit.id} className="p-6 hover:bg-gray-50 transition-colors">
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex items-start space-x-4 flex-1">
                                                            <div className="bg-indigo-100 rounded-full p-3">
                                                                <svg className="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                                </svg>
                                                            </div>
                                                            <div className="flex-1">
                                                                <h3 className="font-semibold text-gray-900">{visit.visitor.name}</h3>
                                                                <p className="text-sm text-gray-600">{visit.visitor.company}</p>
                                                                <p className="text-sm text-gray-500">{visit.purpose}</p>
                                                                <div className="flex items-center space-x-4 mt-2">
                                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                                        visit.approval === 'approved' ? 'bg-green-100 text-green-800' :
                                                                        visit.approval === 'pending' ? 'bg-orange-100 text-orange-800' :
                                                                        'bg-red-100 text-red-800'
                                                                    }`}>
                                                                        {visit.approval === 'approved' ? 'Approved' : visit.approval === 'pending' ? 'Pending' : 'Rejected'}
                                                                    </span>
                                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                                        visit.status === 'checked_in' ? 'bg-green-100 text-green-800' :
                                                                        visit.status === 'checked_out' ? 'bg-gray-100 text-gray-800' :
                                                                        'bg-blue-100 text-blue-800'
                                                                    }`}>
                                                                        {visit.status === 'checked_in' ? 'Checked In' : visit.status === 'checked_out' ? 'Checked Out' : 'Scheduled'}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="text-sm text-gray-600">{visit.timeFrom} - {visit.timeTo}</p>
                                                            <p className="text-xs text-gray-500 font-mono">{visit.code}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Walk-in Form Modal */}
                    {showWalkInForm && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                                <h2 className="text-xl font-bold text-gray-900 mb-4">Register Walk-in Visitor</h2>
                                <form onSubmit={handleWalkInSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Visitor Name *</label>
                                        <input
                                            type="text"
                                            required
                                            value={walkInData.name}
                                            onChange={(e) => setWalkInData({...walkInData, name: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                        <input
                                            type="text"
                                            value={walkInData.company}
                                            onChange={(e) => setWalkInData({...walkInData, company: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                        <input
                                            type="tel"
                                            required
                                            value={walkInData.phone}
                                            onChange={(e) => setWalkInData({...walkInData, phone: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Meeting With *</label>
                                        <select
                                            required
                                            value={walkInData.executiveId}
                                            onChange={(e) => setWalkInData({...walkInData, executiveId: e.target.value})}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        >
                                            {EXECUTIVES.map(exec => (
                                                <option key={exec.id} value={exec.id}>{exec.name} - {exec.position}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Purpose of Visit *</label>
                                        <textarea
                                            required
                                            value={walkInData.purpose}
                                            onChange={(e) => setWalkInData({...walkInData, purpose: e.target.value})}
                                            rows={3}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div className="flex space-x-3 pt-4">
                                        <button
                                            type="button"
                                            onClick={() => setShowWalkInForm(false)}
                                            className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"
                                        >
                                            Generate Pass
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [executives, setExecutives] = useState([]);

            useEffect(() => {
                const loadData = async () => {
                    try {
                        // Load executives from API (needed for login screen)
                        const response = await fetch('/api/executives');
                        if (response.ok) {
                            const data = await response.json();
                            EXECUTIVES = data; // Update global reference
                            setExecutives(data);
                            console.log('Loaded executives from database:', data.length);
                        } else {
                            console.error('Failed to load executives');
                        }
                    } catch (e) {
                        console.error('Error loading data:', e);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadData();
            }, []);

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading Grand City HQ Guest Pass System...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen onLogin={handleLogin} executives={executives} />;
            }

            return (
                <div>
                    <div className="fixed top-4 right-4 z-50">
                        <button
                            onClick={handleLogout}
                            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-lg"
                        >
                            Logout
                        </button>
                    </div>
                    {user.role === 'executive' && <ExecutiveDashboard user={user} />}
                    {user.role === 'staff' && <StaffDashboard />}
                    {user.role === 'guard' && <GuardDashboard />}
                    {user.role === 'receptionist' && <ReceptionistDashboard />}
                    {user.role === 'admin' && <AdminDashboard />}
                </div>
            );
        };

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
