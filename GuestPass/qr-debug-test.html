<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Debug Test</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .qr-container { border: 2px solid #333; padding: 20px; margin: 20px 0; background: white; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const QRDebugApp = () => {
            const [logs, setLogs] = useState([]);
            const [testResults, setTestResults] = useState([]);
            const [qrImage, setQrImage] = useState('');

            const addLog = (message) => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => [...prev, `${timestamp}: ${message}`]);
                console.log(message);
            };

            const testQRGeneration = async () => {
                addLog('=== Starting QR Generation Test ===');
                setTestResults([]);
                setQrImage('');

                try {
                    // Test 1: Check if QRCode library is available
                    addLog('Test 1: Checking QRCode library availability');
                    if (typeof QRCode === 'undefined') {
                        addLog('❌ QRCode library not found!');
                        setTestResults(prev => [...prev, '❌ QRCode library not available']);
                        return;
                    }
                    addLog('✅ QRCode library found');
                    addLog(`QRCode version: ${QRCode.version || 'unknown'}`);
                    setTestResults(prev => [...prev, '✅ QRCode library available']);

                    // Test 2: Try to create a simple QR code
                    addLog('Test 2: Creating simple QR code');
                    const testText = "TEST123";
                    
                    return new Promise((resolve) => {
                        try {
                            const container = document.createElement('div');
                            container.style.width = '256px';
                            container.style.height = '256px';
                            container.style.border = '2px solid red'; // Make it visible for debugging
                            container.style.backgroundColor = 'white';
                            container.style.margin = '20px';
                            
                            document.body.appendChild(container);
                            addLog('✅ Created visible container for debugging');

                            const qrCode = new QRCode(container, {
                                text: testText,
                                width: 256,
                                height: 256,
                                colorDark: '#000000',
                                colorLight: '#FFFFFF',
                                correctLevel: QRCode.CorrectLevel.H
                            });

                            addLog('✅ QRCode instance created');

                            setTimeout(() => {
                                try {
                                    addLog('Checking for canvas/image elements...');
                                    const canvas = container.querySelector('canvas');
                                    const img = container.querySelector('img');

                                    if (canvas) {
                                        addLog('✅ Canvas element found');
                                        addLog(`Canvas dimensions: ${canvas.width}x${canvas.height}`);
                                        
                                        // Analyze pixels
                                        const ctx = canvas.getContext('2d');
                                        const imageData = ctx.getImageData(0, 0, 20, 20);
                                        let blackPixels = 0;
                                        let whitePixels = 0;
                                        
                                        for (let i = 0; i < imageData.data.length; i += 4) {
                                            const r = imageData.data[i];
                                            const g = imageData.data[i + 1];
                                            const b = imageData.data[i + 2];
                                            const a = imageData.data[i + 3];
                                            
                                            if (r < 50 && g < 50 && b < 50 && a > 200) blackPixels++;
                                            else if (r > 200 && g > 200 && b > 200 && a > 200) whitePixels++;
                                        }
                                        
                                        addLog(`Pixel analysis - Black: ${blackPixels}, White: ${whitePixels}`);
                                        
                                        if (blackPixels > 0) {
                                            addLog('✅ QR pattern detected!');
                                            setTestResults(prev => [...prev, '✅ QR pattern found in canvas']);
                                            
                                            // Convert to data URL
                                            const dataUrl = canvas.toDataURL('image/png');
                                            addLog(`✅ Data URL generated, length: ${dataUrl.length}`);
                                            setQrImage(dataUrl);
                                            setTestResults(prev => [...prev, '✅ Data URL created successfully']);
                                        } else {
                                            addLog('⚠️ No QR pattern detected');
                                            setTestResults(prev => [...prev, '⚠️ No QR pattern in canvas']);
                                        }
                                    } else if (img) {
                                        addLog('✅ Image element found');
                                        addLog(`Image src: ${img.src.substring(0, 50)}...`);
                                        setQrImage(img.src);
                                        setTestResults(prev => [...prev, '✅ Image element found']);
                                    } else {
                                        addLog('❌ No canvas or image found');
                                        setTestResults(prev => [...prev, '❌ No QR content found']);
                                    }

                                } catch (error) {
                                    addLog(`❌ Error during analysis: ${error.message}`);
                                    setTestResults(prev => [...prev, `❌ Analysis error: ${error.message}`]);
                                }

                                addLog('=== Test Complete ===');
                                resolve();
                            }, 1000);

                        } catch (error) {
                            addLog(`❌ QR creation error: ${error.message}`);
                            setTestResults(prev => [...prev, `❌ QR creation failed: ${error.message}`]);
                            resolve();
                        }
                    });

                } catch (error) {
                    addLog(`❌ Overall error: ${error.message}`);
                    setTestResults(prev => [...prev, `❌ Overall test failed: ${error.message}`]);
                }
            };

            useEffect(() => {
                addLog('Debug app initialized');
                testQRGeneration();
            }, []);

            return (
                <div>
                    <h1>QR Code Generation Debug Test</h1>
                    
                    <div className="test-section">
                        <h2>Test Results</h2>
                        {testResults.map((result, index) => (
                            <div key={index} className="debug-info">{result}</div>
                        ))}
                    </div>

                    <div className="test-section">
                        <h2>Generated QR Code</h2>
                        {qrImage ? (
                            <div>
                                <img 
                                    src={qrImage} 
                                    alt="Generated QR" 
                                    style={{ 
                                        border: '4px solid black', 
                                        backgroundColor: 'white', 
                                        padding: '20px',
                                        maxWidth: '300px'
                                    }}
                                />
                                <p>QR Code should appear above</p>
                            </div>
                        ) : (
                            <p>No QR code generated yet</p>
                        )}
                    </div>

                    <div className="test-section">
                        <h2>Debug Log</h2>
                        <div style={{ maxHeight: '300px', overflowY: 'auto', background: '#f9f9f9', padding: '10px' }}>
                            {logs.map((log, index) => (
                                <div key={index} style={{ fontSize: '12px', margin: '2px 0' }}>
                                    {log}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<QRDebugApp />, document.getElementById('root'));
    </script>
</body>
</html>