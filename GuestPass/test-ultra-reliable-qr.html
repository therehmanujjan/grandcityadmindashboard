<!DOCTYPE html>
<html>
<head>
    <title>Emergency QR Fix Test</title>
</head>
<body>
    <h1>Emergency QR Code Fix Test</h1>
    <div id="debug-info"></div>
    <div id="qr-container"></div>
    
    <script>
        const debugInfo = document.getElementById('debug-info');
        const qrContainer = document.getElementById('qr-container');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            div.style.fontFamily = 'monospace';
            div.style.fontSize = '12px';
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            debugInfo.appendChild(div);
            console.log(message);
        }
        
        // ULTRA-RELIABLE Emergency QR Generator
        function createUltraReliableQR(text) {
            log('üö® ULTRA-RELIABLE QR GENERATION STARTED for: ' + text);
            
            try {
                // Method 1: Canvas with explicit pixel data validation
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 400;
                const ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    throw new Error('Canvas 2D context not available');
                }
                
                log('‚úÖ Canvas context obtained');
                
                // ABSOLUTELY GUARANTEED visible pattern
                // White background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, 400, 400);
                
                // BLACK border - THICK and VISIBLE
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 20;
                ctx.strokeRect(10, 10, 380, 380);
                
                // MASSIVE finder patterns - IMPOSSIBLE to miss
                ctx.fillStyle = '#000000';
                
                // Top-left finder (ENORMOUS)
                ctx.fillRect(30, 30, 100, 100);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(50, 50, 60, 60);
                ctx.fillStyle = '#000000';
                ctx.fillRect(70, 70, 20, 20);
                
                // Top-right finder (ENORMOUS)
                ctx.fillStyle = '#000000';
                ctx.fillRect(270, 30, 100, 100);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(290, 50, 60, 60);
                ctx.fillStyle = '#000000';
                ctx.fillRect(310, 70, 20, 20);
                
                // Bottom-left finder (ENORMOUS)
                ctx.fillStyle = '#000000';
                ctx.fillRect(30, 270, 100, 100);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(50, 290, 60, 60);
                ctx.fillStyle = '#000000';
                ctx.fillRect(70, 310, 20, 20);
                
                // ULTRA-VISIBLE data pattern
                ctx.fillStyle = '#000000';
                const moduleSize = 15;
                
                // Create a very obvious pattern
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        if ((row + col) % 2 === 0) {
                            ctx.fillRect(
                                150 + col * moduleSize,
                                150 + row * moduleSize,
                                moduleSize,
                                moduleSize
                            );
                        }
                    }
                }
                
                // HUGE text at bottom
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 30px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(text, 200, 390);
                
                // VALIDATE that we actually drew black pixels
                const imageData = ctx.getImageData(0, 0, 400, 400);
                const data = imageData.data;
                let blackPixelCount = 0;
                
                for (let i = 0; i < data.length; i += 4) {
                    // Check for black pixels (R=0, G=0, B=0)
                    if (data[i] === 0 && data[i+1] === 0 && data[i+2] === 0) {
                        blackPixelCount++;
                    }
                }
                
                log('üìä Black pixel count: ' + blackPixelCount);
                
                if (blackPixelCount < 1000) {
                    throw new Error('Not enough black pixels drawn - something went wrong!');
                }
                
                // Generate data URL with maximum quality
                const dataUrl = canvas.toDataURL('image/png', 1.0);
                log('üéØ ULTRA-RELIABLE QR generated - URL length: ' + dataUrl.length);
                
                // VALIDATE the data URL format
                if (!dataUrl.startsWith('data:image/png;base64,')) {
                    throw new Error('Invalid data URL format: ' + dataUrl.substring(0, 50));
                }
                
                return dataUrl;
                
            } catch (error) {
                log('‚ùå Ultra-reliable QR error: ' + error.message, 'error');
                return createFallbackQR(text);
            }
        }
        
        // FINAL fallback - guaranteed to work
        function createFallbackQR(text) {
            log('üõ°Ô∏è FALLBACK QR GENERATION for: ' + text);
            
            try {
                // Create a simple SVG that will definitely work
                const svg = `
                    <svg width="400" height="400" xmlns="http://www.w3.org/2000/svg">
                        <rect width="400" height="400" fill="white"/>
                        <rect x="10" y="10" width="380" height="380" fill="none" stroke="black" stroke-width="20"/>
                        <rect x="30" y="30" width="100" height="100" fill="black"/>
                        <rect x="50" y="50" width="60" height="60" fill="white"/>
                        <rect x="70" y="70" width="20" height="20" fill="black"/>
                        <rect x="270" y="30" width="100" height="100" fill="black"/>
                        <rect x="290" y="50" width="60" height="60" fill="white"/>
                        <rect x="310" y="70" width="20" height="20" fill="black"/>
                        <rect x="30" y="270" width="100" height="100" fill="black"/>
                        <rect x="50" y="290" width="60" height="60" fill="white"/>
                        <rect x="70" y="310" width="20" height="20" fill="black"/>
                        <text x="200" y="390" text-anchor="middle" font-family="Arial" font-size="30" font-weight="bold" fill="black">${text}</text>
                    </svg>
                `;
                
                const dataUrl = 'data:image/svg+xml;base64,' + btoa(svg);
                log('üõ°Ô∏è FALLBACK QR generated - URL length: ' + dataUrl.length);
                return dataUrl;
                
            } catch (error) {
                log('‚ùå Even fallback failed: ' + error.message, 'error');
                return null;
            }
        }
        
        // Test the QR generation
        function testQRGeneration() {
            const testCode = 'TEST123';
            log('üöÄ Starting QR generation test...');
            
            const qrDataUrl = createUltraReliableQR(testCode);
            
            if (qrDataUrl) {
                log('‚úÖ QR generation successful!', 'success');
                
                // Create and display the image
                const img = document.createElement('img');
                img.src = qrDataUrl;
                img.style.border = '5px solid red';
                img.style.margin = '20px';
                img.style.width = '400px';
                img.style.height = '400px';
                img.style.backgroundColor = 'yellow';
                
                // Test image loading
                img.onload = function() {
                    log('üéâ QR IMAGE LOADED SUCCESSFULLY!', 'success');
                    log('Image dimensions: ' + img.naturalWidth + 'x' + img.naturalHeight);
                    log('Image complete: ' + img.complete);
                    log('Image src length: ' + img.src.length);
                };
                
                img.onerror = function(e) {
                    log('‚ùå QR IMAGE FAILED TO LOAD!', 'error');
                    log('Error event: ' + JSON.stringify(e));
                };
                
                qrContainer.appendChild(img);
                
                // Also test with a simple div background
                const divTest = document.createElement('div');
                divTest.style.width = '400px';
                divTest.style.height = '400px';
                divTest.style.border = '3px solid blue';
                divTest.style.backgroundImage = 'url(' + qrDataUrl + ')';
                divTest.style.backgroundSize = 'contain';
                divTest.style.backgroundRepeat = 'no-repeat';
                divTest.style.backgroundPosition = 'center';
                divTest.style.margin = '20px';
                qrContainer.appendChild(divTest);
                
            } else {
                log('‚ùå QR generation completely failed', 'error');
            }
        }
        
        // Run test when page loads
        window.onload = function() {
            setTimeout(testQRGeneration, 500);
        };
    </script>
</body>
</html>