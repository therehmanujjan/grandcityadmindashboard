<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generation Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./qrcode.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">QR Code Generation Test</h1>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Test QR Code with Real Visit Code</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Test Code (same as visit):</label>
                <input type="text" id="testCode" value="GC-2025-000005" class="w-full p-2 border rounded">
            </div>
            
            <button id="generateBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Generate QR Code
            </button>
            
            <button id="testMethodsBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 ml-2">
                Test All Methods
            </button>
        </div>
        
        <div id="status" class="bg-gray-50 p-4 rounded mb-6"></div>
        
        <div id="qrResult" class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-4">QR Code Result:</h3>
            <div id="qrCodeContainer" class="flex justify-center"></div>
        </div>
    </div>

    <script>
        // Copy the exact QR code generation functions from the main system
        const generateQRCode = async (text) => {
            try {
                console.log('Starting QR code generation for:', text);
                
                // Wait for QRCode library to be available
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds timeout
                
                while (typeof QRCode === 'undefined' && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof QRCode === 'undefined') {
                    console.error('QR code library failed to load after 5 seconds');
                    return generateFallbackQR(text);
                }
                
                console.log('QRCode library loaded:', typeof QRCode);
                console.log('QRCode methods available:', Object.keys(QRCode));
                
                // Method 1: Use QRCode constructor directly (most reliable)
                console.log('Trying QRCode constructor method...');
                return new Promise((resolve) => {
                    try {
                        // Create a container div for the QR code
                        const container = document.createElement('div');
                        container.style.width = '200px';
                        container.style.height = '200px';
                        container.style.display = 'none';
                        document.body.appendChild(container);
                        
                        // Create QRCode instance
                        const qrCode = new QRCode(container, {
                            text: text,
                            width: 200,
                            height: 200,
                            colorDark: '#000000',
                            colorLight: '#FFFFFF',
                            correctLevel: QRCode.CorrectLevel.M
                        });
                        
                        console.log('QRCode instance created successfully');
                        
                        // Wait for QR code to be rendered
                        setTimeout(() => {
                            try {
                                // Find the canvas or img element in the container
                                const canvas = container.querySelector('canvas');
                                const img = container.querySelector('img');
                                
                                let dataUrl = '';
                                
                                if (canvas) {
                                    dataUrl = canvas.toDataURL('image/png');
                                    console.log('QR code generated from canvas');
                                } else if (img) {
                                    dataUrl = img.src;
                                    console.log('QR code generated from img src');
                                } else {
                                    console.log('No canvas or img found, trying fallback');
                                    dataUrl = generateFallbackQR(text);
                                }
                                
                                // Clean up
                                document.body.removeChild(container);
                                console.log('QR code data URL length:', dataUrl.length);
                                console.log('QR code data URL preview:', dataUrl.substring(0, 50) + '...');
                                resolve(dataUrl);
                                
                            } catch (renderError) {
                                console.error('QR rendering error:', renderError);
                                document.body.removeChild(container);
                                resolve(generateFallbackQR(text));
                            }
                        }, 500);
                        
                    } catch (constructorError) {
                        console.error('QRCode constructor error:', constructorError);
                        resolve(generateFallbackQR(text));
                    }
                });
                
            } catch (e) {
                console.error('QR generation error:', e);
                return generateFallbackQR(text);
            }
        };

        // Fallback QR code generation using a simple approach
        const generateFallbackQR = (text) => {
            console.log('Using fallback QR generation for:', text);
            try {
                // Create a simple data URL that represents the text in a QR-like format
                // This is a visual fallback, not a real QR code
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    console.error('Canvas 2D context not available');
                    return createTextFallback(text);
                }
                
                // White background
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, 200, 200);
                
                // Black border
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 4;
                ctx.strokeRect(10, 10, 180, 180);
                
                // Add finder patterns (the three big squares in corners)
                ctx.fillStyle = '#000000';
                
                // Top-left finder pattern
                ctx.fillRect(20, 20, 14, 14);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(22, 22, 10, 10);
                ctx.fillStyle = '#000000';
                ctx.fillRect(24, 24, 6, 6);
                
                // Top-right finder pattern
                ctx.fillRect(166, 20, 14, 14);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(168, 22, 10, 10);
                ctx.fillStyle = '#000000';
                ctx.fillRect(170, 24, 6, 6);
                
                // Bottom-left finder pattern
                ctx.fillRect(20, 166, 14, 14);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(22, 168, 10, 10);
                ctx.fillStyle = '#000000';
                ctx.fillRect(24, 170, 6, 6);
                
                // Simple pattern to represent QR code data
                ctx.fillStyle = '#000000';
                const moduleSize = 4;
                const modules = 32;
                
                // Create a simple pattern based on the text
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    hash = ((hash << 5) - hash + text.charCodeAt(i)) & 0xFFFFFFFF;
                }
                
                // Generate a more QR-like pattern in the center area
                for (let row = 8; row < modules - 8; row++) {
                    for (let col = 8; col < modules - 8; col++) {
                        const index = row * modules + col;
                        const shouldFill = (hash + index * 7 + row * 3 + col * 5) % 4 === 0;
                        
                        if (shouldFill) {
                            ctx.fillRect(
                                16 + col * moduleSize,
                                16 + row * moduleSize,
                                moduleSize,
                                moduleSize
                            );
                        }
                    }
                }
                
                // Add the visit code text at the bottom
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 10px monospace';
                ctx.textAlign = 'center';
                ctx.fillText(text, 100, 195);
                
                const dataUrl = canvas.toDataURL('image/png');
                console.log('Fallback QR code generated successfully');
                return dataUrl;
                
            } catch (error) {
                console.error('Fallback QR generation error:', error);
                return createTextFallback(text);
            }
        };

        // Simple text-based fallback when canvas fails
        const createTextFallback = (text) => {
            console.log('Creating text fallback for:', text);
            return `data:image/svg+xml;base64,${btoa(`
                <svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
                    <rect width="200" height="200" fill="white"/>
                    <rect x="10" y="10" width="180" height="180" fill="none" stroke="black" stroke-width="4"/>
                    <rect x="20" y="20" width="14" height="14" fill="black"/>
                    <rect x="22" y="22" width="10" height="10" fill="white"/>
                    <rect x="24" y="24" width="6" height="6" fill="black"/>
                    <rect x="166" y="20" width="14" height="14" fill="black"/>
                    <rect x="168" y="22" width="10" height="10" fill="white"/>
                    <rect x="170" y="24" width="6" height="6" fill="black"/>
                    <rect x="20" y="166" width="14" height="14" fill="black"/>
                    <rect x="22" y="168" width="10" height="10" fill="white"/>
                    <rect x="24" y="170" width="6" height="6" fill="black"/>
                    <text x="100" y="195" text-anchor="middle" font-family="monospace" font-size="10" font-weight="bold">${text}</text>
                </svg>
            `)}`;
        };

        // Test functions
        function testQRGeneration() {
            const statusEl = document.getElementById('status');
            const qrContainer = document.getElementById('qrCodeContainer');
            const testCode = document.getElementById('testCode').value;
            
            statusEl.innerHTML = '';
            qrContainer.innerHTML = '';
            
            console.log('=== QR Code Test Started ===');
            console.log('Test code:', testCode);
            console.log('QRCode library status:', typeof QRCode);
            
            if (typeof QRCode === 'undefined') {
                statusEl.innerHTML = '<div class="text-red-600">‚ùå QRCode library not loaded</div>';
                console.log('‚ùå QRCode library not loaded');
                return;
            }
            
            statusEl.innerHTML = '<div class="text-blue-600">üîÑ Generating QR code...</div>';
            
            generateQRCode(testCode).then(qrUrl => {
                console.log('QR generation completed');
                console.log('QR URL length:', qrUrl.length);
                console.log('QR URL preview:', qrUrl.substring(0, 50) + '...');
                
                if (qrUrl) {
                    statusEl.innerHTML = '<div class="text-green-600">‚úÖ QR code generated successfully</div>';
                    
                    const img = document.createElement('img');
                    img.src = qrUrl;
                    img.className = 'border';
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    qrContainer.appendChild(img);
                    
                    console.log('‚úÖ QR code displayed successfully');
                } else {
                    statusEl.innerHTML = '<div class="text-red-600">‚ùå QR generation failed</div>';
                    console.log('‚ùå QR generation returned empty URL');
                }
            }).catch(error => {
                statusEl.innerHTML = '<div class="text-red-600">‚ùå Error: ' + error.message + '</div>';
                console.error('‚ùå QR generation error:', error);
            });
            
            console.log('=== QR Code Test Completed ===');
        }
        
        function testAllMethods() {
            const statusEl = document.getElementById('status');
            const qrContainer = document.getElementById('qrCodeContainer');
            const testCode = document.getElementById('testCode').value;
            
            statusEl.innerHTML = '<div class="text-blue-600">üîÑ Testing all QR generation methods...</div>';
            qrContainer.innerHTML = '';
            
            console.log('=== Testing All QR Methods ===');
            
            // Test 1: Direct constructor
            try {
                console.log('Test 1: Direct constructor method');
                const container1 = document.createElement('div');
                const qr1 = new QRCode(container1, {
                    text: testCode,
                    width: 100,
                    height: 100,
                    colorDark: '#000000',
                    colorLight: '#FFFFFF',
                    correctLevel: QRCode.CorrectLevel.M
                });
                
                setTimeout(() => {
                    const canvas1 = container1.querySelector('canvas');
                    const img1 = container1.querySelector('img');
                    
                    if (canvas1) {
                        const url1 = canvas1.toDataURL('image/png');
                        console.log('‚úÖ Direct constructor (canvas): SUCCESS');
                        addTestResult('Direct Constructor (Canvas)', url1);
                    } else if (img1) {
                        console.log('‚úÖ Direct constructor (img): SUCCESS');
                        addTestResult('Direct Constructor (IMG)', img1.src);
                    } else {
                        console.log('‚ùå Direct constructor: FAILED - No output found');
                        addTestResult('Direct Constructor', null, 'FAILED - No output');
                    }
                }, 300);
            } catch (e) {
                console.log('‚ùå Direct constructor: ERROR -', e.message);
                addTestResult('Direct Constructor', null, 'ERROR: ' + e.message);
            }
            
            // Test 2: Fallback method
            setTimeout(() => {
                console.log('Test 2: Fallback method');
                try {
                    const fallbackUrl = generateFallbackQR(testCode);
                    if (fallbackUrl) {
                        console.log('‚úÖ Fallback method: SUCCESS');
                        addTestResult('Fallback Method', fallbackUrl);
                    } else {
                        console.log('‚ùå Fallback method: FAILED');
                        addTestResult('Fallback Method', null, 'FAILED');
                    }
                } catch (e) {
                    console.log('‚ùå Fallback method: ERROR -', e.message);
                    addTestResult('Fallback Method', null, 'ERROR: ' + e.message);
                }
            }, 600);
        }
        
        function addTestResult(method, url, error = null) {
            const qrContainer = document.getElementById('qrCodeContainer');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'mb-4 p-4 border rounded';
            
            if (error) {
                resultDiv.innerHTML = `<h4 class="font-semibold text-red-600">${method}: ${error}</h4>`;
            } else if (url) {
                resultDiv.innerHTML = `
                    <h4 class="font-semibold text-green-600">${method}: SUCCESS</h4>
                    <img src="${url}" class="border mt-2" style="max-width: 100px; max-height: 100px;">
                `;
            } else {
                resultDiv.innerHTML = `<h4 class="font-semibold text-red-600">${method}: No URL generated</h4>`;
            }
            
            qrContainer.appendChild(resultDiv);
        }
        
        document.getElementById('generateBtn').addEventListener('click', testQRGeneration);
        document.getElementById('testMethodsBtn').addEventListener('click', testAllMethods);
        
        // Auto-test on load
        window.addEventListener('load', () => {
            console.log('Page loaded, checking QRCode library...');
            console.log('QRCode type:', typeof QRCode);
            console.log('QRCode object:', QRCode);
            
            const statusEl = document.getElementById('status');
            if (typeof QRCode === 'undefined') {
                statusEl.innerHTML = '<div class="text-red-600">‚ùå QRCode library not loaded</div>';
            } else {
                statusEl.innerHTML = '<div class="text-green-600">‚úÖ QRCode library loaded</div>';
            }
        });
    </script>
</body>
</html>